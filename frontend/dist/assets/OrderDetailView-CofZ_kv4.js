import{d as N,c as y,m as T,o as i,a as n,t as c,_ as O,b as z,p as h,h as f,f as a,w as l,q as F,s as V,x as ve,y as _e,z as ye,A as ge,r as w,B as he,g as _,C as K,n as ke,F as R,k as Q,E as v,D as ie,e as be,G as we,u as xe,l as de}from"./index-CP6BfJf4.js";import{u as $e}from"./order-CJPQCLK0.js";import{f as Fe}from"./index-CaunA62S.js";const Ue={key:0,class:"loading-spinner"},Ce={class:"text"},Be=N({__name:"LoadingSpinner",props:{loading:{type:Boolean},text:{}},setup(M){return(g,m)=>g.loading?(i(),y("div",Ue,[m[0]||(m[0]=n("div",{class:"spinner"},null,-1)),n("div",Ce,c(g.text),1)])):T("",!0)}}),Se=O(Be,[["__scopeId","data-v-f8d22632"]]),ze={key:0,class:"error-message"},Ie={class:"content"},Te={class:"title"},Me={class:"message"},De=N({__name:"ErrorMessage",props:{error:{type:Boolean},title:{},message:{},retry:{type:Boolean}},emits:["retry"],setup(M){return(g,m)=>g.error?(i(),y("div",ze,[m[1]||(m[1]=n("div",{class:"icon"},"⚠️",-1)),n("div",Ie,[n("div",Te,c(g.title),1),n("div",Me,c(g.message),1),g.retry?(i(),y("button",{key:0,class:"btn-retry",onClick:m[0]||(m[0]=x=>g.$emit("retry"))},"重试")):T("",!0)])])):T("",!0)}}),Ee=O(De,[["__scopeId","data-v-da856255"]]),Le={class:"file-preview"},Ve={key:1,class:"file-icon"},Re={class:"file-name"},Ne=N({__name:"FilePreview",props:{fileUrl:{},fileName:{},fileType:{}},setup(M){const g=M,m=z(()=>/^image\//.test(g.fileType)),x=z(()=>/^application\/(pdf|msword|vnd\.openxmlformats-officedocument\.wordprocessingml\.document)$/.test(g.fileType)),b=z(()=>/^video\//.test(g.fileType)),I=z(()=>/^audio\//.test(g.fileType));return($,U)=>{const d=f("el-image"),p=f("el-icon");return i(),y("div",Le,[m.value?(i(),h(d,{key:0,src:$.fileUrl,"preview-src-list":[$.fileUrl],fit:"cover"},null,8,["src","preview-src-list"])):(i(),y("div",Ve,[a(p,{size:48},{default:l(()=>[x.value?(i(),h(F(V),{key:0})):b.value?(i(),h(F(ve),{key:1})):I.value?(i(),h(F(_e),{key:2})):(i(),h(F(ye),{key:3}))]),_:1}),n("span",Re,c($.fileName),1)]))])}}}),Oe=O(Ne,[["__scopeId","data-v-6e63d1de"]]),qe={class:"file-uploader"},Ae={class:"el-upload__text"},We={class:"el-upload__tip"},Pe={key:0,class:"upload-queue"},Ge={class:"queue-header"},He={class:"queue-list"},Ke={class:"queue-info"},Qe={class:"file-name"},je={class:"file-size"},Je={key:1,class:"upload-progress"},Xe={class:"progress-info"},Ye={class:"file-name"},Ze={class:"progress-percentage"},et={key:2,class:"file-list"},tt={class:"file-icon"},at={class:"file-info"},lt={class:"file-name"},st={class:"file-meta"},ot={class:"file-size"},nt={class:"file-type"},rt={class:"file-actions"},it=N({__name:"FileUploader",props:{orderId:{},multiple:{type:Boolean},accept:{},maxSize:{}},emits:["upload-success","upload-error","remove"],setup(M,{emit:g}){const m=M,x=g,{t:b}=ge(),I=w(),$=w(!1),U=w([]),d=w(null),p=w([]),C=w([]),B=w(!1),j=z(()=>"/api/files/upload"),J=z(()=>({Authorization:`Bearer ${localStorage.getItem("token")}`})),X=z(()=>({orderId:m.orderId})),D=e=>e<1024?e+" B":e<1024*1024?(e/1024).toFixed(2)+" KB":e<1024*1024*1024?(e/1024/1024).toFixed(2)+" MB":(e/1024/1024/1024).toFixed(2)+" GB",Y=e=>{var r;$.value=!1;const t=(r=e.dataTransfer)==null?void 0:r.files;t&&t.length>0&&Z(t)},Z=e=>{Array.from(e).forEach(t=>{if(m.accept&&!t.type.match(m.accept)){v.error(b("fileUploader.invalidType"));return}if(m.maxSize&&t.size>m.maxSize){v.error(b("fileUploader.tooLarge"));return}C.value.push(t)})},ee=async()=>{var e;if(!B.value){B.value=!0;try{for(const t of C.value)await((e=I.value)==null?void 0:e.upload(t));C.value=[]}catch{v.error(b("fileUploader.uploadError"))}finally{B.value=!1}}},te=e=>{const t=C.value.findIndex(r=>r.uid===e.uid);t>-1&&C.value.splice(t,1)},ae=e=>m.accept&&!e.type.match(m.accept)?(v.error(b("fileUploader.invalidType")),!1):m.maxSize&&e.size>m.maxSize?(v.error(b("fileUploader.tooLarge")),!1):!0,le=(e,t)=>{const r=p.value.findIndex(S=>S.name===t.name);r===-1?p.value.push({name:t.name,percentage:0,status:""}):p.value[r].percentage=Math.round(e.percent||0)},se=(e,t)=>{const r=p.value.findIndex(S=>S.name===t.name);r>-1&&(p.value[r].status="success",setTimeout(()=>{p.value.splice(r,1)},1e3)),U.value.push({id:e.id,name:t.name,size:t.size,url:e.url}),x("upload-success",e),v.success(b("fileUploader.success"))},oe=(e,t)=>{const r=p.value.findIndex(S=>S.name===t.name);r>-1&&(p.value[r].status="exception",setTimeout(()=>{p.value.splice(r,1)},2e3)),x("upload-error",e),v.error(b("fileUploader.error"))},ne=e=>{const t=U.value.indexOf(e);t>-1&&(U.value.splice(t,1),x("remove",e))},re=e=>{d.value=e},q=e=>{var t;return(t=e.type)==null?void 0:t.startsWith("image/")},A=e=>e.type==="application/pdf"||e.name.toLowerCase().endsWith(".pdf"),W=e=>e.type==="application/msword"||e.type==="application/vnd.openxmlformats-officedocument.wordprocessingml.document"||e.name.toLowerCase().endsWith(".doc")||e.name.toLowerCase().endsWith(".docx"),s=e=>e.type==="application/vnd.ms-excel"||e.type==="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"||e.name.toLowerCase().endsWith(".xls")||e.name.toLowerCase().endsWith(".xlsx"),o=e=>q(e)?"图片":A(e)?"PDF":W(e)?"Word":s(e)?"Excel":"文件";return(e,t)=>{const r=f("el-icon"),S=f("el-upload"),E=f("el-button"),L=f("el-progress");return i(),y("div",qe,[n("div",{class:ke(["upload-area",{"is-dragover":$.value}]),onDragenter:t[0]||(t[0]=K(u=>$.value=!0,["prevent"])),onDragleave:t[1]||(t[1]=K(u=>$.value=!1,["prevent"])),onDragover:t[2]||(t[2]=K(()=>{},["prevent"])),onDrop:K(Y,["prevent"])},[a(S,{ref_key:"uploadRef",ref:I,action:j.value,headers:J.value,data:X.value,"on-success":se,"on-error":oe,"before-upload":ae,"on-progress":le,"show-file-list":!1,multiple:e.multiple,accept:e.accept,"auto-upload":!1,drag:""},{tip:l(()=>[n("div",We,c(e.$t("fileUploader.tip",{size:e.maxSize/1024/1024})),1)]),default:l(()=>[a(r,{class:"el-icon--upload"},{default:l(()=>[a(F(he))]),_:1}),n("div",Ae,[_(c(e.$t("fileUploader.dropFile"))+" ",1),n("em",null,c(e.$t("fileUploader.clickToUpload")),1)])]),_:1},8,["action","headers","data","multiple","accept"])],34),C.value.length>0?(i(),y("div",Pe,[n("div",Ge,[n("span",null,c(e.$t("fileUploader.queue",{count:C.value.length})),1),a(E,{type:"primary",size:"small",loading:B.value,onClick:ee},{default:l(()=>[_(c(e.$t("fileUploader.startUpload")),1)]),_:1},8,["loading"])]),n("div",He,[(i(!0),y(R,null,Q(C.value,u=>(i(),y("div",{key:u.uid,class:"queue-item"},[n("div",Ke,[n("span",Qe,c(u.name),1),n("span",je,c(D(u.size)),1)]),a(E,{type:"danger",link:"",onClick:P=>te(u)},{default:l(()=>[a(r,null,{default:l(()=>[a(F(ie))]),_:1})]),_:2},1032,["onClick"])]))),128))])])):T("",!0),p.value.length>0?(i(),y("div",Je,[(i(!0),y(R,null,Q(p.value,u=>(i(),y("div",{key:u.name,class:"progress-item"},[n("div",Xe,[n("span",Ye,c(u.name),1),n("span",Ze,c(u.percentage)+"%",1)]),a(L,{percentage:u.percentage,status:u.status,"stroke-width":4},null,8,["percentage","status"])]))),128))])):T("",!0),U.value.length>0?(i(),y("div",et,[(i(!0),y(R,null,Q(U.value,u=>(i(),y("div",{key:u.id,class:"file-item"},[n("div",tt,[q(u)?(i(),h(r,{key:0,class:"image-icon"},{default:l(()=>t[4]||(t[4]=[n("picture",null,null,-1)])),_:1})):A(u)?(i(),h(r,{key:1,class:"pdf-icon"},{default:l(()=>[a(F(V))]),_:1})):W(u)?(i(),h(r,{key:2,class:"word-icon"},{default:l(()=>[a(F(V))]),_:1})):s(u)?(i(),h(r,{key:3,class:"excel-icon"},{default:l(()=>[a(F(V))]),_:1})):(i(),h(r,{key:4,class:"default-icon"},{default:l(()=>[a(F(V))]),_:1}))]),n("div",at,[n("div",lt,c(u.name),1),n("div",st,[n("span",ot,c(D(u.size)),1),n("span",nt,c(o(u)),1)])]),n("div",rt,[a(E,{type:"primary",link:"",onClick:P=>re(u)},{default:l(()=>[a(r,null,{default:l(()=>t[5]||(t[5]=[n("view",null,null,-1)])),_:1})]),_:2},1032,["onClick"]),a(E,{type:"danger",link:"",onClick:P=>ne(u)},{default:l(()=>[a(r,null,{default:l(()=>[a(F(ie))]),_:1})]),_:2},1032,["onClick"])])]))),128))])):T("",!0),d.value?(i(),h(Oe,{key:3,file:d.value,onClose:t[3]||(t[3]=u=>d.value=null)},null,8,["file"])):T("",!0)])}}}),dt=O(it,[["__scopeId","data-v-8951f441"]]),ut={class:"order-detail"},ct={class:"card-header"},pt={class:"card-header"},mt=N({__name:"OrderDetailView",setup(M){const g=we(),m=xe(),x=$e(),b=w(!1),I=w(!1),$=w(""),U=w(!1),d=w(null),p=w({status:"",notes:""}),C={Authorization:`Bearer ${localStorage.getItem("token")}`},B=async()=>{b.value=!0,I.value=!1;try{const s=g.params.id;d.value=await x.getOrderById(s)}catch{I.value=!0,$.value="加载订单详情失败，请稍后重试",v.error("加载订单详情失败")}finally{b.value=!1}},j=z(()=>{if(!d.value)return[];const s=d.value.status;return[{label:"待处理",value:"pending"},{label:"处理中",value:"processing"},{label:"已完成",value:"completed"},{label:"已取消",value:"cancelled"}].filter(e=>e.value!==s)}),J=s=>({pending:"warning",processing:"primary",completed:"success",cancelled:"info"})[s],X=s=>({pending:"待处理",processing:"处理中",completed:"已完成",cancelled:"已取消"})[s],D=s=>Fe(new Date(s),"yyyy-MM-dd HH:mm:ss"),Y=s=>{if(s===0)return"0 B";const o=1024,e=["B","KB","MB","GB"],t=Math.floor(Math.log(s)/Math.log(o));return parseFloat((s/Math.pow(o,t)).toFixed(2))+" "+e[t]},Z=()=>{var s;m.push(`/orders/${(s=d.value)==null?void 0:s.id}/edit`)},ee=async()=>{try{await de.confirm("确定要删除此订单吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await x.deleteOrder(d.value.id),v.success("订单删除成功"),m.push("/orders")}catch(s){s!=="cancel"&&v.error("删除订单失败")}},te=async()=>{if(!p.value.status){v.warning("请选择新状态");return}U.value=!0;try{await x.updateOrderStatus(d.value.id,{status:p.value.status,notes:p.value.notes}),v.success("状态更新成功"),B(),p.value={status:"",notes:""}}catch{v.error("状态更新失败")}finally{U.value=!1}},ae=s=>s.size/1024/1024<10?!0:(v.error("文件大小不能超过 10MB!"),!1),le=()=>{v.success("文件上传成功"),B()},se=()=>{v.error("文件上传失败")},oe=async s=>{try{const o=await x.downloadFile(d.value.id,s.id),e=window.URL.createObjectURL(new Blob([o])),t=document.createElement("a");t.href=e,t.setAttribute("download",s.name),document.body.appendChild(t),t.click(),document.body.removeChild(t)}catch{v.error("文件下载失败")}},ne=async s=>{try{await de.confirm("确定要删除此文件吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await x.deleteFile(d.value.id,s.id),v.success("文件删除成功"),B()}catch(o){o!=="cancel"&&v.error("文件删除失败")}},re=z(()=>{var s;return((s=d.value)==null?void 0:s.status)==="pending"}),q=s=>{d.value.files.push(s)},A=s=>{console.error("File upload error:",s)},W=s=>{const o=d.value.files.findIndex(e=>e.id===s.id);o>-1&&d.value.files.splice(o,1)};return be(()=>{B()}),(s,o)=>{const e=f("el-button"),t=f("el-button-group"),r=f("el-descriptions-item"),S=f("el-tag"),E=f("el-descriptions"),L=f("el-card"),u=f("el-option"),P=f("el-select"),G=f("el-form-item"),ue=f("el-input"),ce=f("el-form"),pe=f("el-upload"),H=f("el-table-column"),me=f("el-table");return i(),y("div",ut,[b.value?(i(),h(Se,{key:0})):I.value?(i(),h(Ee,{key:1,error:!0,title:"加载失败",message:$.value,retry:!0,onRetry:B},null,8,["message"])):(i(),y(R,{key:2},[a(L,{class:"order-info"},{header:l(()=>[n("div",ct,[o[4]||(o[4]=n("span",null,"订单信息",-1)),a(t,null,{default:l(()=>[a(e,{type:"primary",onClick:Z},{default:l(()=>o[2]||(o[2]=[_("编辑")])),_:1}),re.value?(i(),h(e,{key:0,type:"danger",onClick:ee},{default:l(()=>o[3]||(o[3]=[_("删除")])),_:1})):T("",!0)]),_:1})])]),default:l(()=>[a(E,{column:2,border:""},{default:l(()=>[a(r,{label:"订单号"},{default:l(()=>[_(c(d.value.orderNumber),1)]),_:1}),a(r,{label:"客户名称"},{default:l(()=>[_(c(d.value.customerName),1)]),_:1}),a(r,{label:"产品名称"},{default:l(()=>[_(c(d.value.productName),1)]),_:1}),a(r,{label:"数量"},{default:l(()=>[_(c(d.value.quantity),1)]),_:1}),a(r,{label:"总价"},{default:l(()=>[_("¥"+c(d.value.totalPrice.toFixed(2)),1)]),_:1}),a(r,{label:"状态"},{default:l(()=>[a(S,{type:J(d.value.status)},{default:l(()=>[_(c(X(d.value.status)),1)]),_:1},8,["type"])]),_:1}),a(r,{label:"创建时间"},{default:l(()=>[_(c(D(d.value.createdAt)),1)]),_:1}),a(r,{label:"更新时间"},{default:l(()=>[_(c(D(d.value.updatedAt)),1)]),_:1})]),_:1})]),_:1}),a(L,{class:"status-update"},{header:l(()=>o[5]||(o[5]=[n("div",{class:"card-header"},[n("span",null,"状态更新")],-1)])),default:l(()=>[a(ce,{model:p.value,"label-width":"100px"},{default:l(()=>[a(G,{label:"新状态"},{default:l(()=>[a(P,{modelValue:p.value.status,"onUpdate:modelValue":o[0]||(o[0]=k=>p.value.status=k),placeholder:"请选择状态"},{default:l(()=>[(i(!0),y(R,null,Q(j.value,k=>(i(),h(u,{key:k.value,label:k.label,value:k.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),a(G,{label:"备注"},{default:l(()=>[a(ue,{modelValue:p.value.notes,"onUpdate:modelValue":o[1]||(o[1]=k=>p.value.notes=k),type:"textarea",rows:3,placeholder:"请输入状态更新备注"},null,8,["modelValue"])]),_:1}),a(G,null,{default:l(()=>[a(e,{type:"primary",onClick:te,loading:U.value},{default:l(()=>o[6]||(o[6]=[_(" 更新状态 ")])),_:1},8,["loading"])]),_:1})]),_:1},8,["model"])]),_:1}),a(L,{class:"file-management"},{header:l(()=>[n("div",pt,[o[8]||(o[8]=n("span",null,"文件管理",-1)),a(pe,{class:"upload-btn",action:"/api/orders/files",headers:C,data:{orderId:d.value.id},"on-success":le,"on-error":se,"before-upload":ae},{default:l(()=>[a(e,{type:"primary"},{default:l(()=>o[7]||(o[7]=[_("上传文件")])),_:1})]),_:1},8,["data"])])]),default:l(()=>[a(me,{data:d.value.files,style:{width:"100%"}},{default:l(()=>[a(H,{prop:"name",label:"文件名"}),a(H,{prop:"size",label:"大小",width:"120"},{default:l(({row:k})=>[_(c(Y(k.size)),1)]),_:1}),a(H,{prop:"uploadTime",label:"上传时间",width:"180"},{default:l(({row:k})=>[_(c(D(k.uploadTime)),1)]),_:1}),a(H,{label:"操作",width:"150"},{default:l(({row:k})=>[a(t,null,{default:l(()=>[a(e,{type:"primary",link:"",onClick:fe=>oe(k)},{default:l(()=>o[9]||(o[9]=[_("下载")])),_:2},1032,["onClick"]),a(e,{type:"danger",link:"",onClick:fe=>ne(k)},{default:l(()=>o[10]||(o[10]=[_("删除")])),_:2},1032,["onClick"])]),_:2},1024)]),_:1})]),_:1},8,["data"]),a(G,{label:s.$t("order.detail.files")},{default:l(()=>[a(dt,{"order-id":d.value.id,"max-size":10*1024*1024,onUploadSuccess:q,onUploadError:A,onRemove:W},null,8,["order-id"])]),_:1},8,["label"])]),_:1})],64))])}}}),yt=O(mt,[["__scopeId","data-v-6e13bf99"]]);export{yt as default};
