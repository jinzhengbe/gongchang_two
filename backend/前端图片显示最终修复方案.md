# å‰ç«¯å›¾ç‰‡æ˜¾ç¤ºæœ€ç»ˆä¿®å¤æ–¹æ¡ˆ

## ğŸ¯ é—®é¢˜å·²è§£å†³

ç»è¿‡è¯¦ç»†è¯Šæ–­å’Œä¿®å¤ï¼Œåç«¯é—®é¢˜å·²ç»å®Œå…¨è§£å†³ï¼š

### âœ… åç«¯ä¿®å¤å®Œæˆ
1. **æ¸…ç†äº†æ— æ•ˆçš„å›¾ç‰‡è®°å½•** - ç§»é™¤äº†ä¸å­˜åœ¨çš„æ–‡ä»¶å¼•ç”¨
2. **ä¿ç•™äº†7å¼ å®é™…å­˜åœ¨çš„å›¾ç‰‡** - æ‰€æœ‰å›¾ç‰‡éƒ½å¯ä»¥æ­£å¸¸è®¿é—®
3. **APIæ•°æ®æ­£ç¡®** - å·¥å‚è¯¦æƒ…APIè¿”å›æ­£ç¡®çš„imageså­—æ®µ
4. **å›¾ç‰‡è®¿é—®æ­£å¸¸** - æ‰€æœ‰å›¾ç‰‡HTTPçŠ¶æ€ç 200

### ğŸ“Š å½“å‰çŠ¶æ€
- **æœ‰æ•ˆå›¾ç‰‡æ•°é‡**: 7å¼ 
- **å›¾ç‰‡URLæ ¼å¼**: ç›¸å¯¹è·¯å¾„ `/uploads/xxx.jpg`
- **APIå“åº”**: åŒ…å«æ­£ç¡®çš„imageså­—æ®µ
- **å›¾ç‰‡è®¿é—®**: æ‰€æœ‰å›¾ç‰‡éƒ½å¯ä»¥æ­£å¸¸è®¿é—®

## ğŸ”§ å‰ç«¯ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šä½¿ç”¨å·¥å‚è¯¦æƒ…APIï¼ˆæ¨èï¼‰

```dart
class FactoryProfilePage extends StatefulWidget {
  @override
  _FactoryProfilePageState createState() => _FactoryProfilePageState();
}

class _FactoryProfilePageState extends State<FactoryProfilePage> {
  FactoryProfile? factoryProfile;
  bool isLoading = false;
  String? errorMessage;

  @override
  void initState() {
    super.initState();
    _loadFactoryProfile();
  }

  Future<void> _loadFactoryProfile() async {
    setState(() {
      isLoading = true;
      errorMessage = null;
    });

    try {
      final response = await http.get(
        Uri.parse('http://localhost:8008/api/factories/profile'),
        headers: {
          'Authorization': 'Bearer $token',
        },
      );

      if (response.statusCode == 200) {
        final data = jsonDecode(response.body);
        if (data['code'] == 0) {
          setState(() {
            factoryProfile = FactoryProfile.fromJson(data['data']);
            isLoading = false;
          });
        } else {
          setState(() {
            errorMessage = data['msg'] ?? 'åŠ è½½å¤±è´¥';
            isLoading = false;
          });
        }
      } else {
        setState(() {
          errorMessage = 'ç½‘ç»œé”™è¯¯';
          isLoading = false;
        });
      }
    } catch (e) {
      setState(() {
        errorMessage = 'åŠ è½½å¤±è´¥: $e';
        isLoading = false;
      });
    }
  }

  // å›¾ç‰‡ä¸Šä¼ æˆåŠŸååˆ·æ–°æ•°æ®
  Future<void> _onImageUploadSuccess() async {
    await _loadFactoryProfile();
  }

  Widget _buildPhotosSection() {
    if (factoryProfile?.images == null || factoryProfile!.images.isEmpty) {
      return SizedBox.shrink();
    }

    return Card(
      margin: EdgeInsets.only(bottom: 8),
      child: Padding(
        padding: EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              'å·¥å‚ç…§ç‰‡',
              style: TextStyle(
                fontWeight: FontWeight.bold,
                fontSize: 16,
              ),
            ),
            SizedBox(height: 8),
            SizedBox(
              height: 120,
              child: ListView.builder(
                scrollDirection: Axis.horizontal,
                itemCount: factoryProfile!.images.length,
                itemBuilder: (context, index) {
                  final image = factoryProfile!.images[index];
                  return Container(
                    margin: EdgeInsets.only(right: 8),
                    child: ClipRRect(
                      borderRadius: BorderRadius.circular(8),
                      child: Image.network(
                        _getFullImageUrl(image['url']), // ä½¿ç”¨å®Œæ•´URL
                        width: 120,
                        height: 120,
                        fit: BoxFit.cover,
                        errorBuilder: (context, error, stackTrace) {
                          return Container(
                            width: 120,
                            height: 120,
                            color: Colors.grey[300],
                            child: Icon(Icons.image_not_supported),
                          );
                        },
                      ),
                    ),
                  );
                },
              ),
            ),
          ],
        ),
      ),
    );
  }

  // ç¡®ä¿å›¾ç‰‡URLæ˜¯å®Œæ•´çš„
  String _getFullImageUrl(String url) {
    if (url.startsWith('http')) {
      return url;
    } else {
      return 'http://localhost:8008$url';
    }
  }
}
```

### æ–¹æ¡ˆ2ï¼šä½¿ç”¨å›¾ç‰‡åˆ—è¡¨API

```dart
class FactoryPhotosPage extends StatefulWidget {
  @override
  _FactoryPhotosPageState createState() => _FactoryPhotosPageState();
}

class _FactoryPhotosPageState extends State<FactoryPhotosPage> {
  List<FactoryPhotoInfo> photos = [];
  bool isLoading = false;
  String? errorMessage;

  @override
  void initState() {
    super.initState();
    _loadPhotos();
  }

  Future<void> _loadPhotos() async {
    setState(() {
      isLoading = true;
      errorMessage = null;
    });

    try {
      final response = await http.get(
        Uri.parse('http://localhost:8008/api/factories/4/photos'),
        headers: {
          'Authorization': 'Bearer $token',
        },
      );

      if (response.statusCode == 200) {
        final data = jsonDecode(response.body);
        if (data['success'] == true) {
          setState(() {
            photos = (data['photos'] as List)
                .map((photo) => FactoryPhotoInfo.fromJson(photo))
                .toList();
            isLoading = false;
          });
        } else {
          setState(() {
            errorMessage = data['error'] ?? 'åŠ è½½å¤±è´¥';
            isLoading = false;
          });
        }
      } else {
        setState(() {
          errorMessage = 'ç½‘ç»œé”™è¯¯';
          isLoading = false;
        });
      }
    } catch (e) {
      setState(() {
        errorMessage = 'åŠ è½½å¤±è´¥: $e';
        isLoading = false;
      });
    }
  }

  // å›¾ç‰‡ä¸Šä¼ æˆåŠŸååˆ·æ–°æ•°æ®
  Future<void> _onImageUploadSuccess() async {
    await _loadPhotos();
  }

  Widget _buildPhotosGrid() {
    return GridView.builder(
      gridDelegate: SliverGridDelegateWithFixedCrossAxisCount(
        crossAxisCount: 3,
        crossAxisSpacing: 8,
        mainAxisSpacing: 8,
      ),
      itemCount: photos.length,
      itemBuilder: (context, index) {
        final photo = photos[index];
        return ClipRRect(
          borderRadius: BorderRadius.circular(8),
          child: Image.network(
            _getFullImageUrl(photo.url),
            fit: BoxFit.cover,
            errorBuilder: (context, error, stackTrace) {
              return Container(
                color: Colors.grey[300],
                child: Icon(Icons.image_not_supported),
              );
            },
          ),
        );
      },
    );
  }

  String _getFullImageUrl(String url) {
    if (url.startsWith('http')) {
      return url;
    } else {
      return 'http://localhost:8008$url';
    }
  }
}
```

## ğŸ”‘ å…³é”®ä¿®å¤ç‚¹

### 1. å›¾ç‰‡URLå¤„ç†
```dart
// ç¡®ä¿å›¾ç‰‡URLæ˜¯å®Œæ•´çš„
String _getFullImageUrl(String url) {
  if (url.startsWith('http')) {
    return url;
  } else {
    return 'http://localhost:8008$url'; // æ·»åŠ base URL
  }
}
```

### 2. æ•°æ®åˆ·æ–°æœºåˆ¶
```dart
// å›¾ç‰‡ä¸Šä¼ æˆåŠŸåå¿…é¡»åˆ·æ–°æ•°æ®
Future<void> uploadImages(List<File> files) async {
  try {
    final uploadResponse = await uploadFactoryPhotos(files);
    
    if (uploadResponse['success'] == true) {
      // ä¸Šä¼ æˆåŠŸååˆ·æ–°æ•°æ®
      await _loadFactoryProfile(); // æˆ–è€… _loadPhotos()
      
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('å›¾ç‰‡ä¸Šä¼ æˆåŠŸ')),
      );
    }
  } catch (e) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(content: Text('ä¸Šä¼ å¤±è´¥: $e')),
    );
  }
}
```

### 3. é”™è¯¯å¤„ç†
```dart
Image.network(
  _getFullImageUrl(image['url']),
  fit: BoxFit.cover,
  errorBuilder: (context, error, stackTrace) {
    return Container(
      color: Colors.grey[300],
      child: Icon(Icons.image_not_supported),
    );
  },
)
```

## ğŸ“‹ æµ‹è¯•éªŒè¯

### 1. æ£€æŸ¥APIå“åº”
```javascript
// æµè§ˆå™¨æ§åˆ¶å°æµ‹è¯•
fetch('/api/factories/profile', {
  headers: {
    'Authorization': 'Bearer ' + token
  }
})
.then(response => response.json())
.then(data => {
  console.log('Imageså­—æ®µ:', data.data.images);
  data.data.images.forEach((image, index) => {
    console.log(`å›¾ç‰‡ ${index + 1}:`, image.url);
  });
});
```

### 2. æµ‹è¯•å›¾ç‰‡åŠ è½½
```javascript
// æµ‹è¯•å›¾ç‰‡æ˜¯å¦å¯ä»¥æ­£å¸¸åŠ è½½
data.data.images.forEach((image, index) => {
  const img = new Image();
  img.onload = () => console.log(`âœ… å›¾ç‰‡ ${index + 1} åŠ è½½æˆåŠŸ`);
  img.onerror = () => console.log(`âŒ å›¾ç‰‡ ${index + 1} åŠ è½½å¤±è´¥`);
  img.src = image.url.startsWith('http') ? image.url : 'http://localhost:8008' + image.url;
});
```

## âœ… é¢„æœŸç»“æœ

ä¿®å¤åï¼Œå‰ç«¯åº”è¯¥èƒ½å¤Ÿï¼š

1. **æ­£ç¡®æ˜¾ç¤º7å¼ å›¾ç‰‡** - æ‰€æœ‰å®é™…å­˜åœ¨çš„å›¾ç‰‡éƒ½èƒ½æ˜¾ç¤º
2. **å›¾ç‰‡ä¸Šä¼ åè‡ªåŠ¨åˆ·æ–°** - æ–°ä¸Šä¼ çš„å›¾ç‰‡ç«‹å³æ˜¾ç¤º
3. **é”™è¯¯å¤„ç†å®Œå–„** - å›¾ç‰‡åŠ è½½å¤±è´¥æ—¶æ˜¾ç¤ºå ä½ç¬¦
4. **URLå¤„ç†æ­£ç¡®** - ç›¸å¯¹è·¯å¾„è‡ªåŠ¨æ·»åŠ base URL

## ğŸ‰ æ€»ç»“

åç«¯é—®é¢˜å·²å®Œå…¨è§£å†³ï¼Œå‰ç«¯åªéœ€è¦ï¼š

1. **ä½¿ç”¨å·¥å‚è¯¦æƒ…APIçš„imageså­—æ®µ**
2. **æ·»åŠ base URLå‰ç¼€å¤„ç†ç›¸å¯¹è·¯å¾„**
3. **åœ¨ä¸Šä¼ æˆåŠŸååˆ·æ–°æ•°æ®**
4. **æ·»åŠ é”™è¯¯å¤„ç†**

æŒ‰ç…§ä»¥ä¸Šæ–¹æ¡ˆå®æ–½ï¼Œå›¾ç‰‡æ˜¾ç¤ºé—®é¢˜å°†å®Œå…¨è§£å†³ï¼ 